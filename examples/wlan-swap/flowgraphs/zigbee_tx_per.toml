# ZigBee Transmitter with PER (Packet Error Rate) Test
# Based on zigbee_tx_v2.toml
# 
# Per block replaces FlowgraphController's TX connection to MAC.
# Per sends "testxxGG" messages where GG is the current gain (88 -> 0, step 4)
# Per also controls the SDR sink gain directly.
#
# Flow:
#   per.tx -> mac.tx (packets to send: "testxx88", "testxx84", ...)
#   per.gain -> snk.gain (gain control: 88, 84, 80, ... 0)
#   mac -> modulator -> iq_delay -> throttle -> snk (SDR)

[[blocks]]
name = "flowgraph_controller"
type = "FlowgraphController"

# PER Test Block - replaces flowgraph_controller's TX to MAC
[[blocks]]
name = "per"
type = "zigbee::Per"
[[blocks.parameters]]
name = "gain_start"
type = "f64"
value = 88.0
[[blocks.parameters]]
name = "gain_end"
type = "f64"
value = 0.0
[[blocks.parameters]]
name = "gain_step"
type = "f64"
value = 4.0
[[blocks.parameters]]
name = "packets_per_gain"
type = "i64"
value = 1000
[[blocks.parameters]]
name = "packet_interval_ms"
type = "i64"
value = 10  # 100 packets/sec

# MAC layer (TX side)
[[blocks]]
name = "mac"
type = "zigbee::Mac"

# ZigBee Modulator (composite block)
[[blocks]]
name = "modulator"
type = "zigbee::Modulator"

# IQ Delay (Gaussian filter delay compensation)
[[blocks]]
name = "iq_delay"
type = "zigbee::IqDelay"

# Throttle to avoid buffer overflow
[[blocks]]
name = "throttle"
type = "Throttle"
dtype = "Complex32"
[[blocks.parameters]]
name = "rate"
type = "f64"
value = 1e6  # Match sample_rate

# SDR Sink
[[blocks]]
name = "snk"
type = "seify::Sink"
[[blocks.parameters]]
name = "frequency"
type = "f64"
value = 2.48e9  # channel 26 by default
[[blocks.parameters]]
name = "sample_rate"
type = "f64"
value = 1e6
[[blocks.parameters]]
name = "gain"
type = "f64"
value = 88.0  # Initial gain, will be controlled by Per block
[[blocks.parameters]]
name = "antenna"
type = "string"
value = ""
[[blocks.parameters]]
name = "args"
type = "string"
value = ""

# ============================================================================
# Stream Connections
# ============================================================================
# mac -> modulator -> iq_delay -> throttle -> snk

[[connections]]
from = "mac"
from_port = "output"
to = "modulator"
to_port = "input"

[[connections]]
from = "modulator"
from_port = "output"
to = "iq_delay"
to_port = "input"

[[connections]]
from = "iq_delay"
from_port = "output"
to = "throttle"
to_port = "input"

[[connections]]
from = "throttle"
from_port = "output"
to = "snk"
to_port = "inputs[0]"

# ============================================================================
# Message Connections
# ============================================================================

# FlowgraphController init -> Per ctrl (auto-start the PER test)
[[message_connections]]
from = "flowgraph_controller"
from_port = "tx_out"
to = "per"
to_port = "ctrl"

# Per tx -> MAC tx (packets: "testxx88", "testxx84", etc.)
[[message_connections]]
from = "per"
from_port = "tx"
to = "mac"
to_port = "tx"

# Per gain -> SDR sink gain (88 -> 84 -> 80 -> ... -> 0)
[[message_connections]]
from = "per"
from_port = "gain"
to = "snk"
to_port = "gain"

# ============================================================================
# CLI Arguments
# ============================================================================
[cli]
[[cli.args]]
name = "antenna"
type = "string"
optional = true

[[cli.args]]
name = "args"
type = "string"
optional = true

[[cli.args]]
name = "gain"
type = "f64"
default = 88.0

[[cli.args]]
name = "sample_rate"
type = "f64"
default = 1e6

[[cli.args]]
name = "channel"
type = "f64"
default = 26
parser = "parse_channel"
description = "Zigbee Channel Number (11..26)"
